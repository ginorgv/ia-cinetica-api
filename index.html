<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TIE Kinetic Predictor | By Raúl Vázquez</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 1000px; margin: 2rem auto; padding: 0 20px; color: #333; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        h1, h2 { color: #1a237e; border-bottom: 2px solid #3949ab; padding-bottom: 10px; }
        textarea { width: 100%; height: 180px; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; padding: 10px; box-sizing: border-box; margin-bottom: 1rem; resize: vertical; }
        button { grid-column: 1 / -1; background-color: #3949ab; color: white; border: none; padding: 15px 30px; font-size: 1.2rem; font-weight: bold; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; width: 100%; }
        button:hover { background-color: #1a237e; }
        #results { grid-column: 1 / -1; margin-top: 1rem; }
        .disclaimer { font-size: 0.8rem; color: #777; margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem; grid-column: 1 / -1;}
    </style>
</head>
<body>

    <h1>TIE Kinetic Predictor</h1>
    <p>Una IA determinista que predice la velocidad de traducción ribosomal basándose en la ley física de composición elemental (Vázquez, 2025). Este modelo para <strong>E. coli</strong> ha sido validado con datos experimentales (Hussmann et al., Cell 2021) alcanzando una correlación de <strong>r > 0.98</strong>.</p>
    
    <div class="container">
        <div>
            <h2>Secuencia Original</h2>
            <textarea id="originalSequenceInput" placeholder="Pega aquí la secuencia de ADN o ARNm original..."></textarea>
        </div>
        <div>
            <h2>Secuencia Mutada</h2>
            <textarea id="mutatedSequenceInput" placeholder="Pega aquí la secuencia mutada..."></textarea>
        </div>

        <button onclick="analyzeAndCompare()">🔬 Analizar Impacto de la Mutación</button>

        <div id="results">
            <p>El gráfico comparativo aparecerá aquí.</p>
        </div>

        <p class="disclaimer"><strong>PARA USO EXCLUSIVO EN INVESTIGACIÓN (RUO).</strong> Esta herramienta proporciona predicciones basadas en un modelo teórico y no es un dispositivo de diagnóstico médico. No debe ser utilizada para tomar decisiones clínicas. El usuario asume toda la responsabilidad por el uso de la información proporcionada.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Guardamos una referencia al gráfico para poder destruirlo antes de crear uno nuevo
        let comparisonChart = null;

        async function analyzeAndCompare() {
            const originalSeq = document.getElementById('originalSequenceInput').value;
            const mutatedSeq = document.getElementById('mutatedSequenceInput').value;
            const resultsDiv = document.getElementById('results');
            const button = document.querySelector('button');

            if (!originalSeq || !mutatedSeq) {
                resultsDiv.innerHTML = '<p style="color: red;">Por favor, introduce ambas secuencias.</p>';
                return;
            }

            resultsDiv.innerHTML = '<p>🧠 Analizando ambas secuencias...</p>';
            button.disabled = true;
            button.innerText = 'Calculando...';

            try {
                // !!! IMPORTANTE: REEMPLAZA ESTA URL CON LA TUYA DE RENDER !!!
                const apiUrl = 'https://ia-cinetica-api.onrender.com/api/predict/ecoli';

                // Creamos una función auxiliar para llamar a la API
                const fetchProfile = (sequence) => fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sequence: sequence })
                }).then(response => {
                    if (!response.ok) return response.json().then(err => { throw new Error(err.error) });
                    return response.json();
                });

                // Llamamos a la API para ambas secuencias en paralelo
                const [originalData, mutatedData] = await Promise.all([
                    fetchProfile(originalSeq),
                    fetchProfile(mutatedSeq)
                ]);

                // Destruimos el gráfico anterior si existe
                if (comparisonChart) {
                    comparisonChart.destroy();
                }
                
                resultsDiv.innerHTML = '<h2>Análisis de Impacto Cinético</h2><canvas id="comparisonChartCanvas"></canvas>';
                
                const labels = originalData.map(d => `${d.codon_index}: ${d.codon}`);
                const originalValues = originalData.map(d => d.predicted_pause_ms);
                const mutatedValues = mutatedData.map(d => d.predicted_pause_ms);

                const ctx = document.getElementById('comparisonChartCanvas');
                comparisonChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Original',
                                data: originalValues,
                                borderColor: 'blue',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: 'Mutada',
                                data: mutatedValues,
                                borderColor: 'red',
                                borderDash: [5, 5], // Línea discontinua para la mutada
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: { title: { display: true, text: 'Pausa Predicha (ms)' } },
                            x: { title: { display: true, text: 'Posición del Codón' } }
                        },
                        plugins: {
                            tooltip: { mode: 'index', intersect: false },
                            title: { display: true, text: 'Comparación de Perfiles Cinéticos', font: { size: 16 } }
                        },
                        interaction: { mode: 'index', intersect: false }
                    }
                });

            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${error.message}</p>`;
            } finally {
                button.disabled = false;
                button.innerText = '🔬 Analizar Impacto de la Mutación';
            }
        }
    </script>
</body>
</html>
