<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TIE Kinetic Predictor | By Raúl Vázquez</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 1000px; margin: 2rem auto; padding: 0 20px; color: #333; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        h1, h2 { color: #1a237e; border-bottom: 2px solid #3949ab; padding-bottom: 10px; }
        textarea { width: 100%; height: 180px; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; padding: 10px; box-sizing: border-box; margin-bottom: 1rem; resize: vertical; }
        button { grid-column: 1 / -1; background-color: #3949ab; color: white; border: none; padding: 15px 30px; font-size: 1.2rem; font-weight: bold; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; width: 100%; }
        button:hover { background-color: #1a237e; }
        #results { grid-column: 1 / -1; margin-top: 1rem; }
        .disclaimer { font-size: 0.8rem; color: #777; margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem; grid-column: 1 / -1;}
    </style>
</head>
<body>

    <h1>TIE Kinetic Predictor</h1>
    <p>Una IA determinista que predice la velocidad de traducción ribosomal basándose en la ley física de composición elemental (Vázquez, 2025). Este modelo para <strong>E. coli</strong> ha sido validado con datos experimentales (Hussmann et al., Cell 2021) alcanzando una correlación de <strong>r > 0.98</strong>.</p>
    
    <div class="container">
        <div>
            <h2>Secuencia 1 (Original)</h2>
            <textarea id="sequence1Input" placeholder="Pega aquí la secuencia para analizar su perfil..."></textarea>
        </div>
        <div>
            <h2>Secuencia 2 (Mutada - Opcional)</h2>
            <textarea id="sequence2Input" placeholder="Pega aquí una segunda secuencia para comparar..."></textarea>
        </div>

        <button onclick="masterAnalyze()">🔬 Analizar</button>

        <div id="results">
            <p>Introduce una secuencia en el primer campo para generar su perfil, o en ambos campos para comparar.</p>
        </div>

        <p class="disclaimer"><strong>PARA USO EXCLUSIVO EN INVESTIGACIÓN (RUO).</strong> Esta herramienta proporciona predicciones basadas en un modelo teórico y no es un dispositivo de diagnóstico médico. No debe ser utilizada para tomar decisiones clínicas. El usuario asume toda la responsabilidad por el uso de la información proporcionada.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let activeChart = null; 

        function masterAnalyze() {
            const seq1 = document.getElementById('sequence1Input').value.trim();
            const seq2 = document.getElementById('sequence2Input').value.trim();

            if (seq1 && seq2) {
                analyzeComparison(seq1, seq2);
            } else if (seq1) {
                analyzeSingle(seq1);
            } else {
                document.getElementById('results').innerHTML = '<p style="color: red;">Por favor, introduce al menos la Secuencia 1.</p>';
            }
        }

        async function analyzeSingle(sequence) {
            const resultsDiv = document.getElementById('results');
            const button = document.querySelector('button');
            setupAnalysisUI(button, resultsDiv, '🧠 Analizando perfil de secuencia única...');

            try {
                const data = await fetchProfile(sequence);
                if (data.length === 0) throw new Error("No se encontraron codones válidos en la secuencia.");
                
                renderChart({
                    title: 'Perfil Cinético Estructural',
                    datasets: [{
                        label: 'Pausa Predicha (ms)',
                        data: data.map(d => d.predicted_pause_ms),
                        borderColor: 'navy',
                        backgroundColor: 'rgba(26, 35, 126, 0.1)',
                        fill: true,
                        // Almacenamos los datos originales para usarlos en el tooltip
                        customData: data 
                    }],
                    labels: data.map(d => d.codon_index) // Usamos solo el índice para el eje X
                });
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${error.message}</p>`;
            } finally {
                resetButtonUI(button, '🔬 Analizar');
            }
        }

        async function analyzeComparison(seq1, seq2) {
            const resultsDiv = document.getElementById('results');
            const button = document.querySelector('button');
            setupAnalysisUI(button, resultsDiv, '🧠 Realizando análisis comparativo...');
            
            try {
                const [data1, data2] = await Promise.all([fetchProfile(seq1), fetchProfile(seq2)]);
                
                renderChart({
                    title: 'Comparación de Perfiles Cinéticos',
                    datasets: [
                        {
                            label: 'Secuencia 1 (Original)',
                            data: data1.map(d => d.predicted_pause_ms),
                            borderColor: 'blue',
                            borderWidth: 2,
                            fill: false,
                            customData: data1 // Almacenamos datos de la secuencia 1
                        },
                        {
                            label: 'Secuencia 2 (Mutada)',
                            data: data2.map(d => d.predicted_pause_ms),
                            borderColor: 'red',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            fill: false,
                            customData: data2 // Almacenamos datos de la secuencia 2
                        }
                    ],
                    labels: data1.map(d => d.codon_index) // Usamos solo el índice para el eje X
                });
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${error.message}</p>`;
            } finally {
                resetButtonUI(button, '🔬 Analizar');
            }
        }

        async function fetchProfile(sequence) {
            const apiUrl = 'https://ia-cinetica-api.onrender.com/api/predict/ecoli';
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sequence: sequence })
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || `Error del servidor: ${response.status}`);
            }
            return response.json();
        }

        function renderChart(config) {
            const resultsDiv = document.getElementById('results');
            if (activeChart) activeChart.destroy();
            resultsDiv.innerHTML = `<h2>${config.title}</h2><canvas id="chartCanvas"></canvas>`;
            const ctx = document.getElementById('chartCanvas');
            activeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: config.labels,
                    datasets: config.datasets
                },
                options: {
                    scales: { y: { title: { display: true, text: 'Pausa Predicha (ms)' } }, x: { title: { display: true, text: 'Posición del Codón' } } },
                    plugins: { 
                        // --- ESTA ES LA CORRECCIÓN CLAVE ---
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            callbacks: {
                                // Personalizamos el tooltip para mostrar el codón correcto
                                title: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    return `Posición del Codón: ${index}`;
                                },
                                label: function(context) {
                                    const datasetLabel = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    // Accedemos a los datos personalizados para obtener el codón
                                    const codonData = context.dataset.customData[context.dataIndex];
                                    return `${datasetLabel}: ${codonData.codon} (${value.toFixed(2)} ms)`;
                                }
                            }
                        } 
                    },
                    interaction: { mode: 'index', intersect: false }
                }
            });
        }
        
        function setupAnalysisUI(button, resultsDiv, message) {
            button.disabled = true;
            button.innerText = 'Calculando...';
            resultsDiv.innerHTML = `<p>${message}</p>`;
        }
        
        function resetButtonUI(button, text) {
            button.disabled = false;
            button.innerText = text;
        }
    </script>
</body>
</html>
